<!doctype html>
{% load static %}
<html class="no-js" lang="es">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Servicios online</title>
        <meta name="description" content="Servicios en vivo">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="{% static "css/normalize.css" %}">
        <link rel="stylesheet" href="{% static "css/main.css" %}">
        <script src="{% static "js/vendor/modernizr-2.8.3.min.js" %}"></script>
        
        <!-- leaflet -->
        <link rel="stylesheet" href="https://npmcdn.com/leaflet@1.0.0-rc.3/dist/leaflet.css" />
        
        <!-- bootstrap -->
        <link rel="stylesheet" href="{% static "css/bootstrap.min.css" %}"/>
        <link rel="stylesheet" href="{% static "css/bootstrap-theme.min.css" %}" />
        <style>
        html, body, .container-fluid {
             height: 100%;
        }
        </style>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <!-- Add your site or application content here -->
        <div class="container-fluid">
            <div class="row" style="height: 100%">
                <div class="col-md-2">
                    <br />
                    <div class="panel panel-default" >
                        <div class="panel-heading">
                            <h1 class="panel-title">Cantidad de paraderos a visualizar</h1>
                        </div>
                        <div class="panel-body">
                            <input id="quatity" type="text" class="form-control" placeholder="10">
                            <input type="button" id="updateQuantity" value="actualizar" class="btn btn-default" /> 
                        </div>
                    </div> 
                    <div id="busStopList" class="list-group">
                        <a href="#" class="list-group-item list-group-item-danger">Cras justo odio <span class="badge">14</span></a>
                     </div>
                </div>
                <div class="col-md-10" style="height: 100%;min-height: 100%">
                    <div id="mapid" style="height: 100%;min-height: 100%"></div>
                </div>
            </div>
        </div>
        
        <script src="{% static "js/vendor/jquery-1.12.0.min.js" %}"></script>
        <script src="{% static "js/plugins.js" %}"></script>
        <script src="{% static "js/main.js" %}"></script>
        <script src="{% static "js/bootstrap.min.js" %}"></script>    
        <script src="https://npmcdn.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>
        <!--<script src="js/Leaflet.textpath.js"></script> -->
        <script src="{% static "js/Leaflet.GTFS.js" %}"></script>

        <script>
            $(document).ready(function() { 
                /**
                 * SET MAP
                 */
                var beauchefLocation = L.latLng(-33.457910, -70.663869);
                var map = L.map("mapid", {editable: true}).setView(beauchefLocation, 13);
                DTPM.setLayerControl(map);

                var busStopsLayer = L.layerGroup([]);

                busStopsLayer.addTo(map);

                var overlays = {
                    "paraderos": busStopsLayer,
                };
                L.control.layers({}, overlays).addTo(map);

                /**
                 * LOAD DATA
                 */
                DTPM.loadData(function(){
 
                    function drawMarkersOnMap(data) {
			// first element has the max value

                        // get circle radius
                        var waitingUsers = data.map(function(v){return v.subidas;});
                        var maxWaitingUsers = Math.max(...waitingUsers);
                        waitingUsers = data.map(function(v){return v.subidas / maxWaitingUsers;});
                        var maxRadius = 1000; // pixels

                        //removes prevevius buses
                        busStopsLayer.clearLayers();
                        
                        $.each(data, function(i, v){
                            var latLng = L.latLng(v.latitud, v.longitud);
                            var marker = L.marker(latLng, {
                                icon: DTPM.getBusStopIcon(),
                            });

                            var paramCodigo = "Código: " + v.codigo;
                            var paramTiempoUltBus = "Últimpo bus pasó a las: " + v.tiempoUltimoBus;
                            var paramSubidas = "Gente esperando: " + v.subidas;
                            var params = [];
                            params.push(paramCodigo);
                            params.push(paramTiempoUltBus);
                            params.push(paramSubidas);
                            params = params.join("<br />");

                            marker.bindPopup("<p>" + params + "</p>");
                            
                            var circle = L.circle(latLng, {
                                radius: waitingUsers[i] * maxRadius,
                                stroke: false,
                                fillColor:'red',  //colors[i],
                                fillOpacity: 0.7,
                            });
                            circle.on('click', function(){
                                marker.openPopup();
                            });
                            
                            busStopsLayer.addLayer(circle);
                            busStopsLayer.addLayer(marker);

                            //add element to list group
                            var rowElement = '<a id=' + v.codigoc+ 'href="#" class="list-group-item list-group-item-danger">Cras justo odio <span class="badge">14</span></a>'
                            $('#busStopList').append('').onclick(function(e){
                                marker.openPopup();
                                
                            });
                        });
                    
                        console.log("Map updated");
                    };
                    
                    var timer = 0;
                    // SET BUTTON ACTION
                    var askBusesButton = $("#updateQuantity");
                    askBusesButton.click(function(){
                        var quantity = $("#quantity").val();

                        $.ajax({
                            url: "getMostPopulatedBusStops/" + quantity,
                            success: function(data){
                                drawMarkersOnMap(data);
                            }
                        });
                        
                        //this does the update in the map
                        clearTimeout(timer);
                        timer = setTimeout(function() {
                            askBusesButton.trigger('click');
                        }, 20000);
                    });

                }, "{% static ""%}");
            });
        </script>
    </body>
</html>
