<!doctype html>
{% load static %}
<html class="no-js" lang="es">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Tiempos de viaje</title>
        <meta name="description" content="Servicios en vivo">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="{% static "css/normalize.css" %}">
        <link rel="stylesheet" href="{% static "css/main.css" %}">
        <script src="{% static "js/vendor/modernizr-2.8.3.min.js" %}"></script>
        
        <!-- leaflet -->
        <link rel="stylesheet" href="https://npmcdn.com/leaflet@1.0.1/dist/leaflet.css" />
        
        <!-- bootstrap -->
        <link rel="stylesheet" href="{% static "css/bootstrap.min.css" %}"/>
        <link rel="stylesheet" href="{% static "css/bootstrap-theme.min.css" %}" />
        <style>
        html, body, .container-fluid {
             height: 100%;
        }

        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        } 
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }

        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
        }
        </style>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <!-- Add your site or application content here -->
        <div class="container-fluid">
            <div class="row" style="height: 100%">
                <div class="col-md-12" style="height: 100%">
                    <div id="mapid" style="height: 100%;min-height: 100%"></div>
                </div>
            </div>
        </div>
        
        <script src="{% static "js/vendor/jquery-1.12.0.min.js" %}"></script>
        <script src="{% static "js/plugins.js" %}"></script>
        <script src="{% static "js/main.js" %}"></script>
        <script src="{% static "js/bootstrap.min.js" %}"></script>    
        <script src="https://npmcdn.com/leaflet@1.0.1/dist/leaflet.js"></script>
        <!--<script src="js/Leaflet.textpath.js"></script> -->
        <script src="{% static "js/Leaflet.GTFS.js" %}"></script>
        <script src="{% static "js/leaflet.hotline.js" %}"></script>

        <script>
            $(document).ready(function() { 
                // to make fitBounds only the first time service is loaded
                var oldService = "";

                /**
                 * SET MAP
                 */
                var beauchefLocation = L.latLng(-33.457910, -70.663869);
                var map = L.map("mapid", {editable: true}).setView(beauchefLocation, 12);
                DTPM.setLayerControl(map);
 
                // color for route
                var getColor = function (d) {
                    return d <  0  ? '#c4c4c4' :
                           d <= 15 ? '#ff0000' :
                           d <= 19 ? '#ff9000' :
                           d <= 21 ? '#fff600' :
                           d <= 25 ? '#19ff00' :
                           d <= 30 ? '#0d8900' :
                                     '#2133f2';
                }
                /**
                 * INFO
                 */
                var info = L.control({position: 'bottomleft'});

                info.onAdd = function (map) {
                    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
                    this._div.innerHTML = '<h4>Velocidad por eje</h4>' + 
                        '<b>Muestra de las velocidades presente en los ejes principales de Santiago de chile</b>' + 
                        '<br /> Los datos mostrados consideran la velocidad de los buses de los últimos 15 minutos.' +
                        '<br /> que recorren las calles señaladas.';
                    return this._div;
                };
                info.addTo(map);

                var legend = L.control({position: 'bottomright'});

                legend.onAdd = function (map) {

                    var div = L.DomUtil.create('div', 'info legend'),
                    grades = [0, 15, 19, 21, 25, 30],
                    labels = [];

                    // loop through our density intervals and generate a label with a colored square for each interval
                    for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                        '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                        grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
                    }

                    return div;
                }; 

                legend.addTo(map);

                /**
                 * LOAD DATA
                 */
                DTPM.loadData(function(){
 
                    function draw(data) {
                    
                        var overlays = {};
                        var bounds = null;

                        $.each(data, function(i1, street){
                            var latLngsWithVelocities = [];
                            
                            var _min = 9999;
                            var _max = 0;
                            // order by distOnRoute
                            street.sort(function(a, b) {
                                return a.distOnRoute - b.distOnRoute;
                            });

                            $.each(street, function(i2, section){
                                latLngsWithVelocities.push([
                                    section.latitude, 
                                    section.longitude, 
                                    section.velocity]);
                                /*
                                if (section.velocity < _min)
                                    _min = section.velocity;
                                if (section.velocity > _max)
                                    _max = section.velocity;
                                */
                            });

                            var line = L.hotline(latLngsWithVelocities, {
                                min: -1,//_min,
                                max: 100, //_max,
                                palette: {
                                    0.0:  getColor(0),
                                    0.15: getColor(15),
                                    0.19: getColor(19),
                                    0.21: getColor(21),
                                    0.25: getColor(25),
                                    0.30: getColor(30),
                                    1.0: getColor(100),
                                },
                                weight: 10,
                                outlineColor: '#000000',
                                outlineWidth: 1, 
                                //smoothFactor: 2
                            });
                            // var line = L.polyline(latLngsWithVelocities);
                            overlays[i1] = line;
                            line.bindPopup('<h1>' + '20 Minutos' + '</h1><h3>Quedó la embarrá perrito.</h3>');
                            line.addTo(map);

                            if (bounds == null) {
                                bounds = line.getBounds();
                            } else {
                                bounds.extend(line.getBounds());
                            }
                        });

                        L.control.layers({}, overlays).addTo(map);

                        map.fitBounds(bounds);

                        console.log("Map updated");
                    };
                    
                    $.ajax({
                        url: "getStreetData",
                        success: function(data){
                            draw(data);
                        }
                    });
                        
                }, "{% static ""%}");
            });
        </script>
    </body>
</html>
